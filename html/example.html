<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title> car park </title>
    <link href="../css/tab-carpark.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet">
    <style>
        .boxdraw {
            background: rgba(56, 135, 190, 0.1);
            border: 2px solid #3887be;
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
        }
    </style>
</head>
<body>
<!-- Load the `mapbox-gl-geocoder` plugin. -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
      type="text/css">

<div id="map"></div>
<div class="map-overlay" id="legend"></div>
<div class="map-overlay" id="title">
    <h2>On-street car park and off-street car </h2>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoiemw3NTMiLCJhIjoiY2w5NDZrazlpMDlnMTN3cjJkem5wZnh4bCJ9.JN_WlrfvOBLWZdOfxL322Q';
    var pmap = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/zl753/cl9du7bcj000s15s0jjz7c2c7/draft'
    });
    pmap.boxZoom.disable();

    // Create a popup, but don't add it to the map yet.
    const popup = new mapboxgl.Popup({
        closeButton: false
    });
    // Add the control to the map.
    pmap.addControl(
        new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl
        })
    );
    pmap.on('load', e => {
        // the rest of the code goes in here
        pmap.on('click', 'on-street-parking-bays-9bafrm', e => {
            console.log(e.features[0].properties);
            new mapboxgl.Popup()
                .setLngLat(e.lngLat)
                .setHTML('Address: ' + e.features[0].properties.rd_seg_dsc)
                .addTo(pmap);
            // the code in step 3 below must go in here
        });
        const canvas = pmap.getCanvasContainer();
        let start;
        let current;
        let box;

        canvas.addEventListener('mousedown', mouseDown, true);

        function mousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return new mapboxgl.Point(
                e.clientX - rect.left - canvas.clientLeft,
                e.clientY - rect.top - canvas.clientTop
            );
        }

        function mouseDown(e) {
// Continue the rest of the function if the shiftkey is pressed.
            if (!(e.shiftKey && e.button === 0)) return;

// Disable default drag zooming when the shift key is held down.
            pmap.dragPan.disable();

// Call functions for the following events
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('keydown', onKeyDown);

// Capture the first xy coordinates
            start = mousePos(e);
        }

        function onMouseMove(e) {
// Capture the ongoing xy coordinates
            current = mousePos(e);

// Append the box element if it doesnt exist
            if (!box) {
                box = document.createElement('div');
                box.classList.add('boxdraw');
                canvas.appendChild(box);
            }

            const minX = Math.min(start.x, current.x),
                maxX = Math.max(start.x, current.x),
                minY = Math.min(start.y, current.y),
                maxY = Math.max(start.y, current.y);

// Adjust width and xy position of the box element ongoing
            box.style.transform = `translate(${minX}px, ${minY}px)`;
            box.style.width = maxX - minX + 'px';
            box.style.height = maxY - minY + 'px';
        }

        function onMouseUp(e) {
// Capture xy coordinates
            finish([start, mousePos(e)]);
        }

        function onKeyDown(e) {
// If the ESC key is pressed
            if (e.keyCode === 27) finish();
        }

        function finish(bbox) {
// Remove these events now that finish has been called.
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('keydown', onKeyDown);
            document.removeEventListener('mouseup', onMouseUp);

            if (box) {
                box.parentNode.removeChild(box);
                box = null;
            }

// If bbox exists. use this value as the argument for `queryRenderedFeatures`
            if (bbox) {
                const features = pmap.queryRenderedFeatures(bbox, {
                    layers: ['on-street-parking-bays-9bafrm']
                });

                // if (features.length >= 1000) {
                //     return window.alert('Select a smaller number of features');
                // }


                const ids = features.map((feature) => feature.properties['bay_id']);
                console.log(features);
                pmap.setFilter('on-street-parking-bays-9bafrm', ['in', 'bay_id', ...ids]);
            }

            pmap.dragPan.enable();
        }


        pmap.on('mousemove', (e) => {
            const features = pmap.queryRenderedFeatures(e.point, {
                layers: ['on-street-parking-bays-9bafrm']
            });

// Change the cursor style as a UI indicator.
            pmap.getCanvas().style.cursor = features.length ? 'pointer' : '';


            if (!features.length) {
                popup.remove();
                return;
            }
            popup
                .setLngLat(e.lngLat)
                .setText(e.features[0].properties['bay_id'])
                .addTo(pmap);

        });


        pmap.on('click', 'off-street-car-parks-with-cap-5egxe9', e => {
            console.log(e.features[0].properties);
            new mapboxgl.Popup()
                .setLngLat(e.lngLat)
                .setHTML('Address: ' + e.features[0].properties['street_nam'] + '<br>' + 'Available space: ' + e.features[0].properties.parking_sp)

                .addTo(pmap);
            // the code in step 3 below must go in here
        });
    });

    pmap.on('click', (e) => {
        let feats = pmap.queryRenderedFeatures(
            e.point,
            {layers: ['on-street-parking-bays-9bafrm']}
        );

        if (feats.length === 0) {
            pmap.setFilter('on-street-parking-bays-9bafrm', null);
        }
    });
</script>

</body>
</html>